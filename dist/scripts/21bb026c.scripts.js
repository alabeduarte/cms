"use strict";var app=angular.module("cmsApp",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).when("/posts",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/posts/:sha",{templateUrl:"views/post.html",controller:"PostCtrl"}).otherwise({redirectTo:"/auth"})}]),app.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]),angular.module("cmsApp").controller("PostCtrl",["$scope","$rootScope","$routeParams",function(a,b,c){function d(a){return b.posts.filter(function(b){return b.sha===a}).shift(0)}function e(a){return"https://api.github.com/repos/movimento-sem-terra/site-novo/git/blobs/"+a}function f(a){return"/repos/movimento-sem-terra/site-novo/contents/_drafts/"+a}var g=c.sha;a.post=d(g),a.menuTagOptions=["agricultura camponesa","agronegócio","direitos humanos","educação, cultura e comunicação","lutas e mobilizações","solidariedade internacional","meio ambiente","projeto popular","reforma agrária","transgênicos"],a.sectionOptions=[{label:"Destaque",value:"featured-news"},{label:"Debate",value:"debate"},{label:"Capa",value:"cover"},{label:"MST TV",value:"tv"}],a.labelOptions=[{label:"Artigo",value:"articles"},{label:"Entrevista",value:"interviews"},{label:"Reportagens Especiais",value:"special-stories"}],a.menuTag=void 0,a.section=void 0,a.label=void 0,a.tag="",a.$watch("label",function(b){a.post.setLabel(b)}),a.$watch("menuTag",function(b){a.post.setMenuItem(b)}),a.$watch("section",function(b){a.post.setSection(b)}),b.github.get(e(g)).done(function(b){a.post.loadContentFromJekyllData(atob(b.content)),a.$apply()}),a.save=function(a){b.github.put(f(a.name),{data:JSON.stringify(a.commitData())}).done(function(a){alert("Post salvo com sucesso!"),console.log("Post salvo com sucesso!",a)}).fail(function(a){alert("Erro ao salvar post. Tente novamente."),console.log("error data:",a)})}}]),angular.module("cmsApp").controller("PostsCtrl",["$scope","$rootScope","_","Post",function(a,b,c,d){b.github.get("/repos/movimento-sem-terra/site-novo/contents/_drafts").done(function(e){b.posts=c.map(e,d.makePost),a.$apply()})}]),angular.module("cmsApp").controller("AuthCtrl",["$scope","$rootScope","$location","oauth",function(a,b,c,d){a.authenticate=function(){d.popup("github",function(d,e){return d?alert(d):(b.github=e,c.path("/posts"),void a.$apply())})}}]),angular.module("cmsApp").factory("oauth",function(){var a=window.OAuth;return a.initialize("S2shWzj2Cp87Mg4estazc6DFGQc"),a}),angular.module("cmsApp").directive("ckEditor",function(){return{require:"?ngModel",link:function(a,b,c,d){var e=window.CKEDITOR.replace(b[0]);e.on("instanceReady",function(){e.setData(d.$viewValue)}),e.on("pasteState",function(){a.$apply(function(){d.$setViewValue(e.getData())})}),d.$render=function(){e.setData(d.$modelValue)}}}}),angular.module("cmsApp").factory("_",function(){return window._}),angular.module("cmsApp").service("Post",["_","jsyaml",function(a,b){return{makePost:function(c){var d={};return a.extend(d,c),d.loadContentFromJekyllData=function(a){var c=decodeURIComponent(escape(a)).split("---");d.content={text:c.pop().replace(/^\n/,""),meta:b.load(c.pop())}},d.convertContentToJekyllData=function(){if(!d.content)return"";var a=["---",b.dump(d.content.meta),"---",d.content.text].join("\n");return unescape(encodeURIComponent(a))},d.commitData=function(){return{sha:d.sha,content:btoa(d.convertContentToJekyllData()),message:"commit from cms"}},d.setMenuItem=function(b){d.content&&(d.content.meta.tags=a.filter(d.content.meta.tags,function(a){return!/^menu:/.test(a)}),b&&d.content.meta.tags.push("menu:"+b))},d.setLabel=function(a){return d.content?a?void(d.content.meta.label=a.value):void(d.content.meta.label=""):void 0},d.setSection=function(a){return d.content?a?void(d.content.meta.section=a.value):void(d.content.meta.section=""):void 0},d.addNewTag=function(a){d.content.meta.tags&&(a="personalizada:"+a,d.content.meta.tags.push(a))},d.uploadImage=function(a){var b=new XMLHttpRequest,c=new FormData,d=this;c.append("myfile",a),b.upload.onprogress=function(){console.log("indoooo...")},b.onload=function(){var a=d._transformResponse(b.response);console.log(a)},b.onerror=function(){console.log("error")},b.onabort=function(){console.log("abort")},c.append("token","insert_token"),b.open("POST","http://mst-image-service.herokuapp.com/upload",!0),b.send(c)},d}}}]),angular.module("cmsApp").factory("jsyaml",function(){return window.jsyaml});